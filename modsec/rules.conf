# Basic WAF Rules

# Block SQL Injection
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS_NAMES|ARGS|XML:/* "@detectSQLi" \
    "id:1000,phase:2,deny,status:403,log,msg:'SQL Injection Attack'"

# Block XSS
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_HEADERS|ARGS_NAMES|ARGS|XML:/* "@detectXSS" \
    "id:1001,phase:2,deny,status:403,log,msg:'XSS Attack'"

# Block Directory Traversal
SecRule REQUEST_URI|ARGS "@contains .." \
    "id:1002,phase:2,deny,status:403,log,msg:'Directory Traversal Attack'"

# API Rate Limiting (per endpoint)
SecAction \
    "id:1003,\
    phase:1,\
    nolog,\
    pass,\
    setvar:ip.block_timeout=300,\
    setvar:ip.api_request_limit=60"

SecRule &IP:REQUEST_COUNT "@gt %{ip.api_request_limit}" \
    "id:1004,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'API Rate Limit Exceeded'"

# Laravel-specific Security Rules

# Block PHP Object Injection
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES|REQUEST_BODY|REQUEST_HEADERS "@rx O:[0-9]+:.*|C:[0-9]+:.*" \
    "id:1100,\
    phase:2,\
    block,\
    log,\
    msg:'PHP Object Injection Attempt',\
    severity:'CRITICAL',\
    deny,\
    status:403"

# Protect Laravel Routes
SecRule REQUEST_URI "@rx /\.env$" \
    "id:1101,\
    phase:2,\
    block,\
    log,\
    msg:'Attempt to access .env file',\
    severity:'CRITICAL',\
    deny,\
    status:403"

# Block Access to Sensitive Laravel Files
SecRule REQUEST_URI "@rx (?:/composer\.json|/composer\.lock|/storage/.*|/bootstrap/.*|/config/.*|/database/.*|/routes/.*|/vendor/.*)$" \
    "id:1102,\
    phase:2,\
    block,\
    log,\
    msg:'Attempt to access sensitive Laravel files',\
    severity:'CRITICAL',\
    deny,\
    status:403"

# Protect Against Mass Assignment
SecRule REQUEST_METHOD "@streq POST" \
    "chain,\
    id:1103,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Potential Mass Assignment Attack'"
    SecRule REQUEST_HEADERS:Content-Type "@contains application/json" "chain"
    SecRule REQUEST_BODY "@rx (\"(id|created_at|updated_at|deleted_at|remember_token|password_hash)\")"

# CSRF Protection for Non-API Routes
SecRule REQUEST_METHOD "^(?:POST|PUT|DELETE|PATCH)$" \
    "chain,\
    id:1104,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Missing CSRF Token'"
    SecRule &REQUEST_HEADERS:X-CSRF-TOKEN "@eq 0" "chain"
    SecRule &REQUEST_HEADERS:X-XSRF-TOKEN "@eq 0" "chain"
    SecRule REQUEST_URI "!@rx ^/api/"

# Block Laravel Debug Mode Exposure
SecRule RESPONSE_BODY "@contains stack_trace" \
    "id:1105,\
    phase:4,\
    block,\
    log,\
    msg:'Laravel Debug Information Leaked',\
    severity:'CRITICAL',\
    deny,\
    status:403"

# Protect API Authentication
SecRule REQUEST_URI "@rx ^/api/" \
    "chain,\
    id:1106,\
    phase:2,\
    deny,\
    status:401,\
    log,\
    msg:'Missing API Authentication'"
    SecRule &REQUEST_HEADERS:Authorization "@eq 0"

# Block Common Laravel Attack Patterns
SecRule REQUEST_URI|ARGS_NAMES|ARGS|REQUEST_HEADERS|!REQUEST_HEADERS:Referer "@rx (?i:(?:\b(?:select|update|insert|delete|drop|union|declare|alter)\b.*\b(?:from|into|table)\b)|(?:\b(?:exec|execute|shell_exec|eval|system|passthru)\b))" \
    "id:1107,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Laravel SQL/Command Injection Attempt',\
    severity:'CRITICAL'"

# Protect File Upload Routes
SecRule REQUEST_URI "@rx /upload|/storage/upload|/api/.*upload" \
    "chain,\
    id:1108,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Invalid File Upload Attempt'"
    SecRule REQUEST_METHOD "@streq POST" "chain"
    SecRule REQUEST_HEADERS:Content-Type "!@rx ^multipart/form-data"

# Block Laravel Log Poisoning
SecRule REQUEST_HEADERS|REQUEST_HEADERS_NAMES|ARGS_NAMES|ARGS "@rx [\n\r]" \
    "id:1109,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Log Injection Attempt',\
    severity:'CRITICAL'"
